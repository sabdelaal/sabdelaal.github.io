<!DOCTYPE html> <html lang="en-US"> <head prefix="og: http://ogp.me/ns#"> <!-- TODO only add social media tags when keys are present! --> <meta charset="UTF-8" /> <meta http-equiv="X-UA-Compatible" content="ie=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <meta name="mobile-web-app-capable" content="yes" /> <meta name="apple-mobile-web-app-capable" content="yes" /> <meta name="application-name" content="Safwan Abdel Aal" /> <meta name="apple-mobile-web-app-status-bar-style" content="#fff" /> <meta name="apple-mobile-web-app-title" content="Safwan Abdel Aal" /> <title> Async Tcp Socket Server/Client in C# - Safwan Abdel Aal </title> <link rel="alternate" href="https://sabdelaal.github.io/projects/async-tcp" hreflang="en-US" /> <link rel="canonical" href="https://sabdelaal.github.io/projects/async-tcp" /> <meta name="description" content="learning by doing" /> <meta name="referrer" content="no-referrer-when-downgrade" /><meta property="fb:app_id" content="" /><meta property="og:site_name" content="Async Tcp Socket Server/Client in C# | Safwan Abdel Aal" /> <meta property="og:title" content="Async Tcp Socket Server/Client in C# | Safwan Abdel Aal" /> <meta property="og:type" content="website" /> <meta property="og:url" content="https://sabdelaal.github.io/projects/async-tcp" /> <meta property="og:description" content="learning by doing" /> <meta property="og:image" content="" /> <meta property="og:image:width" content="640" /> <meta property="og:image:height" content="640" /> <meta name="twitter:card" content="summary" /> <meta name="twitter:title" content="Async Tcp Socket Server/Client in C# | " /> <meta name="twitter:url" content="https://sabdelaal.github.io/projects/async-tcp" /> <meta name="twitter:site" content="@" /> <meta name="twitter:creator" content="@" /> <meta name="twitter:description" content="learning by doing" /> <meta name="twitter:image" content="" /> <link type="application/atom+xml" rel="alternate" href="https://sabdelaal.github.io/feed.xml" title="Safwan Abdel Aal" /> <!-- TODO make it available on mobile <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicons/apple-touch-icon.png" /> <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/favicon-32x32.png" /> <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicons/favicon-16x16.png" /> <link rel="manifest" href="/assets/favicons/site.webmanifest" /> <link rel="mask-icon" href="/assets/favicons/safari-pinned-tab.svg" color="#5bbad5" /> --> <meta name="msapplication-TileColor" content="#da532c" /> <meta name="theme-color" content="#2c2c2c" /> <link rel="stylesheet" href="/assets/css/style.css" /></head> <body data-theme="light" class="notransition"> <script> const body = document.body; const setUtterancesTheme = theme => { const utterances = document.querySelector('.utterances-frame'); if (!utterances) return; utterances.contentWindow.postMessage( {type: 'set-theme', theme: `github-${theme}`}, 'https://utteranc.es', ); }; const setMixcloudTheme = theme => { const oldTheme = theme == 'light' ? 'dark' : 'light'; const selection = document.getElementsByTagName('iframe'); const iframes = Array.prototype.slice.call(selection); iframes.forEach(iframe => { if (!iframe.src.match(/mixcloud/g)) { return; } iframe.setAttribute('src', iframe.src.replace(oldTheme, theme)); }); }; const initTheme = theme => { if (!theme) theme = body.getAttribute('data-theme'); localStorage.setItem('theme', theme); body.setAttribute('data-theme', theme); setUtterancesTheme(theme); setMixcloudTheme(theme); }; window.initTheme = initTheme; initTheme(localStorage.getItem("theme")); setTimeout(() => body.classList.remove("notransition"), 75); addEventListener('message', event => { if (event.origin !== 'https://utteranc.es') return; setUtterancesTheme(localStorage.getItem("theme")); }); </script> <div class="navbar" role="navigation"> <nav class="menu"> <input type="checkbox" id="menu-trigger" class="menu-trigger" /> <label for="menu-trigger"> <span class="menu-icon"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <path d="M64,384H448V341.33H64Zm0-106.67H448V234.67H64ZM64,128v42.67H448V128Z" /> </svg> </span> </label> <a id="mode"> <svg class="mode-sunny" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>LIGHT</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> <svg class="mode-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>DARK</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> </a> <div class="title"> <a class="menu-link active" href="https://sabdelaal.github.io">Safwan Abdel Aal</a> </div> <div class="trigger"> <div class="trigger-container"><a class="menu-link" href="/">blog</a><a class="menu-link" href="/about">about</a><a class="menu-link" href="/music">music</a><a class="menu-link" href="/ideas">ideas</a><a class="menu-link rss" href="/feed.xml"> <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 512 512" fill="#ED812E" > <title>RSS</title> <path d="M108.56,342.78a60.34,60.34,0,1,0,60.56,60.44A60.63,60.63,0,0,0,108.56,342.78Z" /> <path d="M48,186.67v86.55c52,0,101.94,15.39,138.67,52.11s52,86.56,52,138.67h86.66C325.33,312.44,199.67,186.67,48,186.67Z" /> <path d="M48,48v86.56c185.25,0,329.22,144.08,329.22,329.44H464C464,234.66,277.67,48,48,48Z" /> </svg> </a> </div> </div> </nav> </div> <div class="wrapper post"> <main class="page-content" aria-label="Content"> <article itemscope itemtype="https://schema.org/BlogPosting"> <header class="header"> <h1 class="header-title" itemprop="headline">Async Tcp Socket Server/Client in C#</h1> <div class="post-meta"> <time datetime="2018-04-18T00:15:00+03:00" itemprop="datePublished"> Apr 17, 2018 </time> <span itemprop="author" itemscope itemtype="https://schema.org/Person"> <span itemprop="name">Safwan Abdel Aal</span> </span> <time hidden datetime="" itemprop="dateModified"> Apr 17, 2018 </time> <span hidden itemprop="publisher" itemtype="Person">Safwan Abdel Aal</span> <span hidden itemprop="image"></span> <span hidden itemprop="mainEntityOfPage"></span> </div> </header> <div class="page-content" itemprop="articleBody"> <p>I wanted to program a server which can handle alot of clients at the same time just like <a href="https://de.wikipedia.org/wiki/Massively_Multiplayer_Online_Role-Playing_Game">MMORP</a>-Servers do.</p> <p>Many Languages are capable of doing this, but most of them are optimized for Web-Servers.<br /> Another important aspect is the amount of data being sent over the stream. There shouldnâ€™t be any limit for the package size.</p> <h2 id="code"> <a href="#code" class="anchor-head"></a> Code </h2> <p>Enough talking. Here are the complete codeblocks for each client- and serverside.<br /> I implemented a little bit more code than above in the tutorial, but everything should be well explained in the comments.<br /> Feel free to use this code and maybe program your own little MMORPG software.</p> <p><a href="https://github.com/scriptworld-git/Async-Socket-TCP">Click here</a> to see the GitHub repository.</p> <h3 id="client"> <a href="#client" class="anchor-head"></a> Client </h3> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">ATclient</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">BUFFER_SIZE</span> <span class="p">=</span> <span class="m">1024</span><span class="p">;</span>
        <span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">PACKAGE_LENGTH_SIZE</span> <span class="p">=</span> <span class="m">4</span><span class="p">;</span>

        <span class="k">private</span> <span class="n">Socket</span> <span class="n">clientSocket</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Socket</span><span class="p">(</span><span class="n">AddressFamily</span><span class="p">.</span><span class="n">InterNetwork</span><span class="p">,</span> <span class="n">SocketType</span><span class="p">.</span><span class="n">Stream</span><span class="p">,</span> <span class="n">ProtocolType</span><span class="p">.</span><span class="n">Tcp</span><span class="p">);</span>

        <span class="k">private</span> <span class="kt">string</span> <span class="n">ip</span><span class="p">;</span>
        <span class="k">private</span> <span class="kt">int</span> <span class="n">port</span><span class="p">;</span>

        <span class="c1">//synchronize connected attribute</span>
        <span class="k">private</span> <span class="k">static</span> <span class="n">Object</span> <span class="n">Lock</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Object</span><span class="p">();</span>
        <span class="k">private</span> <span class="kt">bool</span> <span class="n">_connected</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="k">public</span> <span class="kt">bool</span> <span class="n">connected</span>
        <span class="p">{</span>
            <span class="k">get</span>
            <span class="p">{</span>
                <span class="k">lock</span> <span class="p">(</span><span class="n">Lock</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">return</span> <span class="n">_connected</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">set</span>
            <span class="p">{</span>
                <span class="k">lock</span> <span class="p">(</span><span class="n">Lock</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">_connected</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">if</span><span class="p">(</span><span class="k">value</span> <span class="p">==</span> <span class="k">false</span><span class="p">){</span>
                    <span class="c1">//fire disconnect event</span>
                    <span class="n">disconnecting</span><span class="p">?.</span><span class="nf">Invoke</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">//disconnecing event</span>
        <span class="k">public</span> <span class="k">delegate</span> <span class="k">void</span> <span class="nf">standardHandler</span><span class="p">();</span>
        <span class="k">public</span> <span class="k">event</span> <span class="n">standardHandler</span> <span class="n">disconnecting</span><span class="p">;</span>

        <span class="c1">//events for logging messages</span>
        <span class="k">public</span> <span class="k">delegate</span> <span class="k">void</span> <span class="nf">consoleLog</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">);</span>
        <span class="k">public</span> <span class="k">event</span> <span class="n">consoleLog</span> <span class="n">consoleLogging</span><span class="p">;</span>

        <span class="err">#</span><span class="n">region</span> <span class="n">Connect</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">connect</span><span class="p">(</span><span class="kt">string</span> <span class="n">ip</span> <span class="p">=</span> <span class="s">"127.0.0.1"</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span> <span class="p">=</span> <span class="m">5000</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="n">ip</span> <span class="p">=</span> <span class="n">ip</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="n">port</span> <span class="p">=</span> <span class="n">port</span><span class="p">;</span>

            <span class="nf">log</span><span class="p">(</span><span class="s">"Connecting to server..."</span><span class="p">);</span>

            <span class="k">try</span>
            <span class="p">{</span>
                <span class="n">clientSocket</span><span class="p">.</span><span class="nf">BeginConnect</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="k">new</span> <span class="nf">AsyncCallback</span><span class="p">(</span><span class="n">connectCallback</span><span class="p">),</span> <span class="n">clientSocket</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">catch</span>
            <span class="p">{</span>
                <span class="n">connected</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>

                <span class="nf">log</span><span class="p">(</span><span class="s">"Failed to connect to Server."</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="nf">log</span><span class="p">(</span><span class="s">$"Client set up to communicate with Server </span><span class="p">{</span><span class="n">ip</span><span class="p">}</span><span class="s"> with Port </span><span class="p">{</span><span class="n">port</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="err">#</span><span class="n">endregion</span>

        <span class="err">#</span><span class="n">region</span> <span class="n">Recieve</span>
        <span class="k">private</span> <span class="k">void</span> <span class="nf">connectCallback</span><span class="p">(</span><span class="n">IAsyncResult</span> <span class="n">ar</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="n">Socket</span> <span class="n">tempS</span> <span class="p">=</span> <span class="n">ar</span><span class="p">.</span><span class="n">AsyncState</span> <span class="k">as</span> <span class="n">Socket</span><span class="p">;</span>
                <span class="n">tempS</span><span class="p">.</span><span class="nf">EndConnect</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

                <span class="nf">log</span><span class="p">(</span><span class="s">"Connected."</span><span class="p">);</span>
                <span class="n">connected</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>

                <span class="n">packageState</span> <span class="n">package</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">packageState</span><span class="p">(</span><span class="n">tempS</span><span class="p">);</span>

                <span class="n">tempS</span><span class="p">.</span><span class="nf">BeginReceive</span><span class="p">(</span><span class="n">package</span><span class="p">.</span><span class="n">sizeBuffer</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">package</span><span class="p">.</span><span class="n">sizeBuffer</span><span class="p">.</span><span class="n">Length</span><span class="p">,</span> <span class="n">SocketFlags</span><span class="p">.</span><span class="n">None</span><span class="p">,</span> <span class="k">new</span> <span class="nf">AsyncCallback</span><span class="p">(</span><span class="n">recieveCallback</span><span class="p">),</span> <span class="n">package</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">catch</span>
            <span class="p">{</span>
                <span class="n">connected</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
                <span class="nf">log</span><span class="p">(</span><span class="s">"Failed to connect to Server."</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">recieveCallback</span><span class="p">(</span><span class="n">IAsyncResult</span> <span class="n">ar</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="n">packageState</span> <span class="n">package</span> <span class="p">=</span> <span class="n">ar</span><span class="p">.</span><span class="n">AsyncState</span> <span class="k">as</span> <span class="n">packageState</span><span class="p">;</span>
                <span class="n">Socket</span> <span class="n">clientS</span> <span class="p">=</span> <span class="n">package</span><span class="p">.</span><span class="n">socket</span><span class="p">;</span>

                <span class="kt">int</span> <span class="n">bytesRead</span> <span class="p">=</span> <span class="n">clientS</span><span class="p">.</span><span class="nf">EndReceive</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">bytesRead</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="kt">int</span> <span class="n">size</span> <span class="p">=</span> <span class="n">ATclient</span><span class="p">.</span><span class="n">BUFFER_SIZE</span><span class="p">;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">package</span><span class="p">.</span><span class="n">readOffset</span> <span class="p">==</span> <span class="p">-</span><span class="m">1</span><span class="p">)</span>
                    <span class="c1">//got new package</span>
                    <span class="p">{</span>
                        <span class="n">size</span> <span class="p">=</span> <span class="n">BitConverter</span><span class="p">.</span><span class="nf">ToInt32</span><span class="p">(</span><span class="n">package</span><span class="p">.</span><span class="n">sizeBuffer</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
                        <span class="n">package</span><span class="p">.</span><span class="n">readBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="n">size</span><span class="p">];</span>
                        <span class="n">package</span><span class="p">.</span><span class="n">readOffset</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>

                    <span class="p">}</span>
                    <span class="k">else</span>
                    <span class="c1">//recieved data belongs to old package</span>
                    <span class="p">{</span>
                        <span class="n">package</span><span class="p">.</span><span class="n">readOffset</span> <span class="p">+=</span> <span class="n">bytesRead</span><span class="p">;</span>

                        <span class="k">if</span> <span class="p">(</span><span class="n">package</span><span class="p">.</span><span class="n">readOffset</span> <span class="p">==</span> <span class="n">package</span><span class="p">.</span><span class="n">readBuffer</span><span class="p">.</span><span class="n">Length</span><span class="p">)</span>
                        <span class="c1">//all data for this package is read</span>
                        <span class="p">{</span>
                            <span class="c1">//clone array so the package can be disposed</span>
                            <span class="kt">byte</span><span class="p">[]</span> <span class="n">temp</span> <span class="p">=</span> <span class="n">package</span><span class="p">.</span><span class="n">readBuffer</span><span class="p">.</span><span class="nf">Clone</span><span class="p">()</span> <span class="k">as</span> <span class="kt">byte</span><span class="p">[];</span>

                            <span class="c1">//TODO IMPLEMENT</span>
                            <span class="c1">//TEMP IS THE RECIEVED DATA</span>
                            <span class="c1">//HANDLE DATA HERE</span>

                            <span class="c1">//free memory</span>
                            <span class="n">package</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>
                            <span class="n">package</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">packageState</span><span class="p">(</span><span class="n">clientS</span><span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">}</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">package</span><span class="p">.</span><span class="n">readBuffer</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                    <span class="c1">//new package</span>
                    <span class="p">{</span>
                        <span class="n">package</span><span class="p">.</span><span class="n">socket</span><span class="p">.</span><span class="nf">BeginReceive</span><span class="p">(</span><span class="n">package</span><span class="p">.</span><span class="n">sizeBuffer</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">package</span><span class="p">.</span><span class="n">sizeBuffer</span><span class="p">.</span><span class="n">Length</span><span class="p">,</span> <span class="n">SocketFlags</span><span class="p">.</span><span class="n">None</span><span class="p">,</span> <span class="k">new</span> <span class="nf">AsyncCallback</span><span class="p">(</span><span class="n">recieveCallback</span><span class="p">),</span> <span class="n">package</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">else</span>
                    <span class="c1">//read max buffer size or rest of the package size</span>
                    <span class="p">{</span>
                        <span class="kt">int</span> <span class="n">readsize</span> <span class="p">=</span> <span class="p">(</span><span class="n">ATclient</span><span class="p">.</span><span class="n">BUFFER_SIZE</span> <span class="p">&gt;</span> <span class="n">size</span><span class="p">)</span> <span class="p">?</span> <span class="n">size</span> <span class="p">:</span> <span class="n">ATclient</span><span class="p">.</span><span class="n">BUFFER_SIZE</span><span class="p">;</span>
                        <span class="n">package</span><span class="p">.</span><span class="n">socket</span><span class="p">.</span><span class="nf">BeginReceive</span><span class="p">(</span><span class="n">package</span><span class="p">.</span><span class="n">readBuffer</span><span class="p">,</span> <span class="n">package</span><span class="p">.</span><span class="n">readOffset</span><span class="p">,</span> <span class="n">readsize</span><span class="p">,</span> <span class="n">SocketFlags</span><span class="p">.</span><span class="n">None</span><span class="p">,</span> <span class="k">new</span> <span class="nf">AsyncCallback</span><span class="p">(</span><span class="n">recieveCallback</span><span class="p">),</span> <span class="n">package</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="n">connected</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
                    <span class="nf">log</span><span class="p">(</span><span class="s">"Error recieving Message! ReadBytes &lt; 0."</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">catch</span>
            <span class="p">{</span>
                <span class="n">connected</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
                <span class="nf">log</span><span class="p">(</span><span class="s">"Error recieving Message!"</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="err">#</span><span class="n">endregion</span>

        <span class="err">#</span><span class="n">region</span> <span class="n">Send</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">sendData</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">data</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">connected</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">try</span>
                <span class="p">{</span>
                    <span class="c1">//send sizeinfo</span>
                    <span class="kt">byte</span><span class="p">[]</span> <span class="n">sizeInfo</span> <span class="p">=</span> <span class="n">BitConverter</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
                    <span class="n">clientSocket</span><span class="p">.</span><span class="nf">BeginSend</span><span class="p">(</span><span class="n">sizeInfo</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">sizeInfo</span><span class="p">.</span><span class="n">Length</span><span class="p">,</span> <span class="n">SocketFlags</span><span class="p">.</span><span class="n">None</span><span class="p">,</span> <span class="k">new</span> <span class="nf">AsyncCallback</span><span class="p">(</span><span class="n">sendCallback</span><span class="p">),</span> <span class="n">clientSocket</span><span class="p">);</span>

                    <span class="c1">//send data</span>
                    <span class="n">clientSocket</span><span class="p">.</span><span class="nf">BeginSend</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">Length</span><span class="p">,</span> <span class="n">SocketFlags</span><span class="p">.</span><span class="n">None</span><span class="p">,</span> <span class="k">new</span> <span class="nf">AsyncCallback</span><span class="p">(</span><span class="n">sendCallback</span><span class="p">),</span> <span class="n">clientSocket</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">catch</span>
                <span class="p">{</span>
                    <span class="n">connected</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="nf">log</span><span class="p">(</span><span class="s">"Can't send Data. You are not connected to the Server."</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">sendCallback</span><span class="p">(</span><span class="n">IAsyncResult</span> <span class="n">ar</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="n">Socket</span> <span class="n">clientS</span> <span class="p">=</span> <span class="n">ar</span><span class="p">.</span><span class="n">AsyncState</span> <span class="k">as</span> <span class="n">Socket</span><span class="p">;</span>
                <span class="kt">int</span> <span class="n">sizeSend</span> <span class="p">=</span> <span class="n">clientS</span><span class="p">.</span><span class="nf">EndSend</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

                <span class="nf">log</span><span class="p">(</span><span class="s">$"Sent </span><span class="p">{</span><span class="n">sizeSend</span><span class="p">}</span><span class="s"> Bytes to the Server."</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">catch</span>
            <span class="p">{</span>
                <span class="n">connected</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
                <span class="nf">log</span><span class="p">(</span><span class="s">"Failed sending Message!"</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="err">#</span><span class="n">endregion</span>

        <span class="k">internal</span> <span class="k">void</span> <span class="nf">log</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">consoleLogging</span><span class="p">?.</span><span class="nf">Invoke</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">internal</span> <span class="k">class</span> <span class="nc">packageState</span> <span class="p">:</span> <span class="n">IDisposable</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="n">Socket</span> <span class="n">socket</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
        <span class="k">public</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">sizeBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="n">ATclient</span><span class="p">.</span><span class="n">PACKAGE_LENGTH_SIZE</span><span class="p">];</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">readOffset</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
        <span class="k">public</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">readBuffer</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">packageState</span><span class="p">(</span><span class="n">Socket</span> <span class="n">s</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="n">socket</span> <span class="p">=</span> <span class="n">s</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="err">#</span><span class="n">region</span> <span class="n">IDisposable</span> <span class="n">Support</span>
        <span class="c1">//free memory</span>
        <span class="k">private</span> <span class="kt">bool</span> <span class="n">disposedValue</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="k">protected</span> <span class="k">virtual</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">(</span><span class="kt">bool</span> <span class="n">disposing</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(!</span><span class="n">disposedValue</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">disposing</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">socket</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
                    <span class="n">sizeBuffer</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
                    <span class="n">readBuffer</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="n">disposedValue</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="nf">Dispose</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
            <span class="n">GC</span><span class="p">.</span><span class="nf">SuppressFinalize</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="err">#</span><span class="n">endregion</span>
    <span class="p">}</span>
</code></pre></div></div> <h3 id="server"> <a href="#server" class="anchor-head"></a> Server </h3> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">public</span> <span class="k">class</span> <span class="nc">ATserver</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">MAX_PENDING_CONNECTIONS</span> <span class="p">=</span> <span class="m">20</span><span class="p">;</span>
        <span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">MAX_CLIENTS</span> <span class="p">=</span> <span class="m">1000</span><span class="p">;</span>

        <span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">BUFFER_SIZE</span> <span class="p">=</span> <span class="m">1024</span><span class="p">;</span>
        <span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">PACKAGE_LENGTH_SIZE</span> <span class="p">=</span> <span class="m">4</span><span class="p">;</span>

        <span class="k">private</span> <span class="n">Socket</span> <span class="n">serverSocket</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Socket</span><span class="p">(</span><span class="n">AddressFamily</span><span class="p">.</span><span class="n">InterNetwork</span><span class="p">,</span> <span class="n">SocketType</span><span class="p">.</span><span class="n">Stream</span><span class="p">,</span> <span class="n">ProtocolType</span><span class="p">.</span><span class="n">Tcp</span><span class="p">);</span>

        <span class="k">private</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">client</span><span class="p">&gt;</span> <span class="n">clients</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">client</span><span class="p">&gt;();</span>

        <span class="c1">//public events</span>
        <span class="k">public</span> <span class="k">event</span> <span class="n">clientHandler</span> <span class="n">clientConnecting</span><span class="p">;</span>
        <span class="k">public</span> <span class="k">event</span> <span class="n">clientHandler</span> <span class="n">clientDisconnecting</span><span class="p">;</span>
        <span class="k">public</span> <span class="k">delegate</span> <span class="k">void</span> <span class="nf">clientHandler</span><span class="p">(</span><span class="kt">int</span> <span class="n">clientID</span><span class="p">);</span>

        <span class="c1">//log events</span>
        <span class="k">public</span> <span class="k">event</span> <span class="n">stringHandler</span> <span class="n">consoleLogged</span><span class="p">;</span>
        <span class="k">public</span> <span class="k">delegate</span> <span class="k">void</span> <span class="nf">stringHandler</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">);</span>

        <span class="c1">//recieving data handler</span>
        <span class="k">public</span> <span class="k">delegate</span> <span class="k">void</span> <span class="nf">clientByteHandler</span><span class="p">(</span><span class="kt">int</span> <span class="n">clientID</span><span class="p">,</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">data</span><span class="p">);</span>

        <span class="err">#</span><span class="n">region</span> <span class="n">Connect</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">start</span><span class="p">(</span><span class="kt">int</span> <span class="n">port</span> <span class="p">=</span> <span class="m">5000</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">serverSocket</span><span class="p">.</span><span class="nf">Bind</span><span class="p">(</span><span class="k">new</span> <span class="nf">IPEndPoint</span><span class="p">(</span><span class="n">IPAddress</span><span class="p">.</span><span class="n">Any</span><span class="p">,</span> <span class="n">port</span><span class="p">));</span>
            <span class="n">serverSocket</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="n">ATserver</span><span class="p">.</span><span class="n">MAX_PENDING_CONNECTIONS</span><span class="p">);</span>
            <span class="n">serverSocket</span><span class="p">.</span><span class="nf">BeginAccept</span><span class="p">(</span><span class="k">new</span> <span class="nf">AsyncCallback</span><span class="p">(</span><span class="n">acceptCallback</span><span class="p">),</span> <span class="n">serverSocket</span><span class="p">);</span>

            <span class="nf">log</span><span class="p">(</span><span class="s">$"Server listening on Port: </span><span class="p">{</span><span class="n">port</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">acceptCallback</span><span class="p">(</span><span class="n">IAsyncResult</span> <span class="n">ar</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="n">Socket</span> <span class="n">serverS</span> <span class="p">=</span> <span class="n">ar</span><span class="p">.</span><span class="n">AsyncState</span> <span class="k">as</span> <span class="n">Socket</span><span class="p">;</span>

                <span class="n">Socket</span> <span class="n">clientSocket</span> <span class="p">=</span> <span class="n">serverS</span><span class="p">.</span><span class="nf">EndAccept</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
                <span class="n">serverS</span><span class="p">.</span><span class="nf">BeginAccept</span><span class="p">(</span><span class="k">new</span> <span class="nf">AsyncCallback</span><span class="p">(</span><span class="n">acceptCallback</span><span class="p">),</span> <span class="n">serverS</span><span class="p">);</span>

                <span class="nf">log</span><span class="p">(</span><span class="s">$"Connection from </span><span class="p">{</span><span class="n">clientSocket</span><span class="p">.</span><span class="n">RemoteEndPoint</span><span class="p">.</span><span class="nf">ToString</span><span class="p">()}</span><span class="s"> recieved."</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">clients</span><span class="p">.</span><span class="n">Count</span> <span class="p">&lt;</span> <span class="n">ATserver</span><span class="p">.</span><span class="n">MAX_CLIENTS</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">client</span> <span class="n">c</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">client</span><span class="p">(</span><span class="n">clientSocket</span><span class="p">);</span>
                    <span class="n">clients</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

                    <span class="c1">//connect all the events from the client</span>
                    <span class="n">c</span><span class="p">.</span><span class="n">clientDisconnecting</span> <span class="p">+=</span> <span class="n">clientDisconnected</span><span class="p">;</span>
                    <span class="n">c</span><span class="p">.</span><span class="n">recievingData</span> <span class="p">+=</span> <span class="n">recievedData</span><span class="p">;</span>
                    <span class="n">c</span><span class="p">.</span><span class="n">consoleLogging</span> <span class="p">+=</span> <span class="n">log</span><span class="p">;</span>

                    <span class="c1">//start the client</span>
                    <span class="n">c</span><span class="p">.</span><span class="nf">startClient</span><span class="p">();</span>
                    <span class="c1">//fire the event that a client is connected</span>
                    <span class="n">clientConnecting</span><span class="p">?.</span><span class="nf">Invoke</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="n">clientSocket</span><span class="p">.</span><span class="nf">Close</span><span class="p">();</span>
                    <span class="nf">log</span><span class="p">(</span><span class="s">$"Max Number of Clients connected is reached. IP: </span><span class="p">{</span><span class="n">clientSocket</span><span class="p">.</span><span class="n">RemoteEndPoint</span><span class="p">.</span><span class="nf">ToString</span><span class="p">()}</span><span class="s"> got declined."</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">catch</span>
            <span class="p">{</span>
                <span class="nf">log</span><span class="p">(</span><span class="s">"Error accepting connection!"</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">clientDisconnected</span><span class="p">(</span><span class="kt">int</span> <span class="n">clientID</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">client</span> <span class="n">client</span> <span class="p">=</span> <span class="n">clients</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">id</span> <span class="p">==</span> <span class="n">clientID</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">client</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">clientDisconnecting</span><span class="p">?.</span><span class="nf">Invoke</span><span class="p">(</span><span class="n">clientID</span><span class="p">);</span>

                <span class="n">clients</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

                <span class="n">client</span><span class="p">.</span><span class="n">clientDisconnecting</span> <span class="p">-=</span> <span class="n">clientDisconnected</span><span class="p">;</span>
                <span class="n">client</span><span class="p">.</span><span class="n">recievingData</span> <span class="p">-=</span> <span class="n">recievedData</span><span class="p">;</span>
                <span class="n">client</span><span class="p">.</span><span class="n">consoleLogging</span> <span class="p">-=</span> <span class="n">log</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">recievedData</span><span class="p">(</span><span class="kt">int</span> <span class="n">clientID</span><span class="p">,</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">data</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//TODO HANDLE DATA FROM THE CLIENT</span>
        <span class="p">}</span>
        <span class="err">#</span><span class="n">endregion</span>

        <span class="err">#</span><span class="n">region</span> <span class="n">Send</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">sendDataTo</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">data</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">client</span> <span class="n">c</span> <span class="p">=</span> <span class="n">clients</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">id</span> <span class="p">==</span> <span class="n">id</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">c</span><span class="p">.</span><span class="nf">sendData</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="nf">log</span><span class="p">(</span><span class="s">$"Couldn't find client with ID: </span><span class="p">{</span><span class="n">id</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="err">#</span><span class="n">endregion</span>

        <span class="k">internal</span> <span class="k">void</span> <span class="nf">log</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">consoleLogged</span><span class="p">?.</span><span class="nf">Invoke</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">internal</span> <span class="k">class</span> <span class="nc">client</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">static</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">idList</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;();</span>

        <span class="k">private</span> <span class="n">Socket</span> <span class="n">socket</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>

        <span class="k">public</span> <span class="k">event</span> <span class="n">clientByteHandler</span> <span class="n">recievingData</span><span class="p">;</span>
        <span class="k">public</span> <span class="k">event</span> <span class="n">clientHandler</span> <span class="n">clientDisconnecting</span><span class="p">;</span>
        <span class="k">public</span> <span class="k">event</span> <span class="n">stringHandler</span> <span class="n">consoleLogging</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">client</span><span class="p">(</span><span class="n">Socket</span> <span class="n">s</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">id</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>

            <span class="k">while</span> <span class="p">(</span><span class="n">idList</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="n">id</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">id</span><span class="p">++;</span>
            <span class="p">}</span>

            <span class="k">this</span><span class="p">.</span><span class="n">socket</span> <span class="p">=</span> <span class="n">s</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="err">#</span><span class="n">region</span> <span class="n">Setup</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">startClient</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">packageState</span> <span class="n">package</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">packageState</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">socket</span><span class="p">);</span>

            <span class="n">socket</span><span class="p">.</span><span class="nf">BeginReceive</span><span class="p">(</span><span class="n">package</span><span class="p">.</span><span class="n">sizeBuffer</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">package</span><span class="p">.</span><span class="n">sizeBuffer</span><span class="p">.</span><span class="n">Length</span><span class="p">,</span> <span class="n">SocketFlags</span><span class="p">.</span><span class="n">None</span><span class="p">,</span> <span class="k">new</span> <span class="nf">AsyncCallback</span><span class="p">(</span><span class="n">recieveCallback</span><span class="p">),</span> <span class="n">package</span><span class="p">);</span>

            <span class="nf">log</span><span class="p">(</span><span class="s">$"Client: </span><span class="p">{</span><span class="n">id</span><span class="p">}</span><span class="s"> is set up."</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">recieveCallback</span><span class="p">(</span><span class="n">IAsyncResult</span> <span class="n">ar</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nf">log</span><span class="p">(</span><span class="s">$"Data from Client: </span><span class="p">{</span><span class="n">id</span><span class="p">}</span><span class="s"> recieved."</span><span class="p">);</span>

            <span class="k">try</span>
            <span class="p">{</span>
                <span class="n">packageState</span> <span class="n">package</span> <span class="p">=</span> <span class="n">ar</span><span class="p">.</span><span class="n">AsyncState</span> <span class="k">as</span> <span class="n">packageState</span><span class="p">;</span>
                <span class="n">Socket</span> <span class="n">clientS</span> <span class="p">=</span> <span class="n">package</span><span class="p">.</span><span class="n">socket</span><span class="p">;</span>

                <span class="kt">int</span> <span class="n">bytesRead</span> <span class="p">=</span> <span class="n">clientS</span><span class="p">.</span><span class="nf">EndReceive</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">bytesRead</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="kt">int</span> <span class="n">size</span> <span class="p">=</span> <span class="n">ATserver</span><span class="p">.</span><span class="n">BUFFER_SIZE</span><span class="p">;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">package</span><span class="p">.</span><span class="n">readOffset</span> <span class="p">==</span> <span class="p">-</span><span class="m">1</span><span class="p">)</span>
                    <span class="c1">//new package</span>
                    <span class="p">{</span>
                        <span class="n">size</span> <span class="p">=</span> <span class="n">BitConverter</span><span class="p">.</span><span class="nf">ToInt32</span><span class="p">(</span><span class="n">package</span><span class="p">.</span><span class="n">sizeBuffer</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
                        <span class="n">package</span><span class="p">.</span><span class="n">readBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="n">size</span><span class="p">];</span>
                        <span class="n">package</span><span class="p">.</span><span class="n">readOffset</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">else</span>
                    <span class="c1">//add data to existing package</span>
                    <span class="p">{</span>
                        <span class="n">package</span><span class="p">.</span><span class="n">readOffset</span> <span class="p">+=</span> <span class="n">bytesRead</span><span class="p">;</span>

                        <span class="k">if</span> <span class="p">(</span><span class="n">package</span><span class="p">.</span><span class="n">readOffset</span> <span class="p">==</span> <span class="n">package</span><span class="p">.</span><span class="n">readBuffer</span><span class="p">.</span><span class="n">Length</span><span class="p">)</span>
                        <span class="c1">//package fully read</span>
                        <span class="p">{</span>
                            <span class="c1">//clone array so the package can be disposed</span>
                            <span class="kt">byte</span><span class="p">[]</span> <span class="n">temp</span> <span class="p">=</span> <span class="n">package</span><span class="p">.</span><span class="n">readBuffer</span><span class="p">.</span><span class="nf">Clone</span><span class="p">()</span> <span class="k">as</span> <span class="kt">byte</span><span class="p">[];</span>

                            <span class="c1">//invoke the event</span>
                            <span class="c1">//temp is the recieved data!</span>
                            <span class="n">recievingData</span><span class="p">?.</span><span class="nf">Invoke</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

                            <span class="c1">//free memory</span>
                            <span class="n">package</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>
                            <span class="n">package</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">packageState</span><span class="p">(</span><span class="n">clientS</span><span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">}</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">package</span><span class="p">.</span><span class="n">readBuffer</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                    <span class="c1">//new package</span>
                    <span class="p">{</span>
                        <span class="n">package</span><span class="p">.</span><span class="n">socket</span><span class="p">.</span><span class="nf">BeginReceive</span><span class="p">(</span><span class="n">package</span><span class="p">.</span><span class="n">sizeBuffer</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">package</span><span class="p">.</span><span class="n">sizeBuffer</span><span class="p">.</span><span class="n">Length</span><span class="p">,</span> <span class="n">SocketFlags</span><span class="p">.</span><span class="n">None</span><span class="p">,</span> <span class="k">new</span> <span class="nf">AsyncCallback</span><span class="p">(</span><span class="n">recieveCallback</span><span class="p">),</span> <span class="n">package</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">else</span>
                    <span class="c1">//read rest of the bytelength</span>
                    <span class="p">{</span>
                        <span class="kt">int</span> <span class="n">readsize</span> <span class="p">=</span> <span class="p">(</span><span class="n">ATserver</span><span class="p">.</span><span class="n">BUFFER_SIZE</span> <span class="p">&gt;</span> <span class="n">size</span><span class="p">)</span> <span class="p">?</span> <span class="n">size</span> <span class="p">:</span> <span class="n">ATserver</span><span class="p">.</span><span class="n">BUFFER_SIZE</span><span class="p">;</span>
                        <span class="n">package</span><span class="p">.</span><span class="n">socket</span><span class="p">.</span><span class="nf">BeginReceive</span><span class="p">(</span><span class="n">package</span><span class="p">.</span><span class="n">readBuffer</span><span class="p">,</span> <span class="n">package</span><span class="p">.</span><span class="n">readOffset</span><span class="p">,</span> <span class="n">readsize</span><span class="p">,</span> <span class="n">SocketFlags</span><span class="p">.</span><span class="n">None</span><span class="p">,</span> <span class="k">new</span> <span class="nf">AsyncCallback</span><span class="p">(</span><span class="n">recieveCallback</span><span class="p">),</span> <span class="n">package</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="nf">log</span><span class="p">(</span><span class="s">"Error recieving Message! ReadBytes &lt; 0."</span><span class="p">);</span>
                    <span class="nf">closeClient</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">catch</span>
            <span class="p">{</span>
                <span class="nf">log</span><span class="p">(</span><span class="s">"Error recieving Message!"</span><span class="p">);</span>
                <span class="nf">closeClient</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">closeClient</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="nf">log</span><span class="p">(</span><span class="s">$"Connection from </span><span class="p">{</span><span class="n">socket</span><span class="p">.</span><span class="n">RemoteEndPoint</span><span class="p">.</span><span class="nf">ToString</span><span class="p">()}</span><span class="s"> has been terminated. Client-ID: </span><span class="p">{</span><span class="n">id</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>

            <span class="n">socket</span><span class="p">.</span><span class="nf">Close</span><span class="p">();</span>

            <span class="c1">//Client Disconnected</span>
            <span class="nf">clientDisconnecting</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="err">#</span><span class="n">endregion</span>

        <span class="err">#</span><span class="n">region</span> <span class="n">Send</span> <span class="p">/</span> <span class="n">Recieve</span> <span class="n">Data</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">sendData</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">data</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="c1">//send sizeinfo</span>
                <span class="kt">byte</span><span class="p">[]</span> <span class="n">sizeInfo</span> <span class="p">=</span> <span class="n">BitConverter</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
                <span class="k">this</span><span class="p">.</span><span class="n">socket</span><span class="p">.</span><span class="nf">BeginSend</span><span class="p">(</span><span class="n">sizeInfo</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">sizeInfo</span><span class="p">.</span><span class="n">Length</span><span class="p">,</span> <span class="n">SocketFlags</span><span class="p">.</span><span class="n">None</span><span class="p">,</span> <span class="k">new</span> <span class="nf">AsyncCallback</span><span class="p">(</span><span class="n">sendCallback</span><span class="p">),</span> <span class="k">this</span><span class="p">.</span><span class="n">socket</span><span class="p">);</span>

                <span class="c1">//send data</span>
                <span class="k">this</span><span class="p">.</span><span class="n">socket</span><span class="p">.</span><span class="nf">BeginSend</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">Length</span><span class="p">,</span> <span class="n">SocketFlags</span><span class="p">.</span><span class="n">None</span><span class="p">,</span> <span class="k">new</span> <span class="nf">AsyncCallback</span><span class="p">(</span><span class="n">sendCallback</span><span class="p">),</span> <span class="k">this</span><span class="p">.</span><span class="n">socket</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">catch</span>
            <span class="p">{</span>
                <span class="nf">log</span><span class="p">(</span><span class="s">"Error sending Message to the Client: "</span> <span class="p">+</span> <span class="k">this</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
                <span class="nf">closeClient</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">sendCallback</span><span class="p">(</span><span class="n">IAsyncResult</span> <span class="n">ar</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="n">Socket</span> <span class="n">clientS</span> <span class="p">=</span> <span class="n">ar</span><span class="p">.</span><span class="n">AsyncState</span> <span class="k">as</span> <span class="n">Socket</span><span class="p">;</span>
                <span class="kt">int</span> <span class="n">sizeSend</span> <span class="p">=</span> <span class="n">clientS</span><span class="p">.</span><span class="nf">EndSend</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

                <span class="nf">log</span><span class="p">(</span><span class="s">$"Sent </span><span class="p">{</span><span class="n">sizeSend</span><span class="p">}</span><span class="s"> Bytes to the Server."</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">catch</span>
            <span class="p">{</span>
                <span class="nf">log</span><span class="p">(</span><span class="s">"Failed sending Message!"</span><span class="p">);</span>
                <span class="nf">closeClient</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="err">#</span><span class="n">endregion</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">log</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">consoleLogging</span><span class="p">?.</span><span class="nf">Invoke</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">internal</span> <span class="k">class</span> <span class="nc">packageState</span> <span class="p">:</span> <span class="n">IDisposable</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="n">Socket</span> <span class="n">socket</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
        <span class="k">public</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">sizeBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="n">ATserver</span><span class="p">.</span><span class="n">PACKAGE_LENGTH_SIZE</span><span class="p">];</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">readOffset</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
        <span class="k">public</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">readBuffer</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">packageState</span><span class="p">(</span><span class="n">Socket</span> <span class="n">s</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="n">socket</span> <span class="p">=</span> <span class="n">s</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="err">#</span><span class="n">region</span> <span class="n">IDisposable</span> <span class="n">Support</span>
        <span class="c1">//free memory</span>
        <span class="k">private</span> <span class="kt">bool</span> <span class="n">disposedValue</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="k">protected</span> <span class="k">virtual</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">(</span><span class="kt">bool</span> <span class="n">disposing</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(!</span><span class="n">disposedValue</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">disposing</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">socket</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
                    <span class="n">sizeBuffer</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
                    <span class="n">readBuffer</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="n">disposedValue</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="nf">Dispose</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
            <span class="n">GC</span><span class="p">.</span><span class="nf">SuppressFinalize</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="err">#</span><span class="n">endregion</span>
    <span class="p">}</span>
</code></pre></div></div> </div> </article> </main> <footer class="footer"><a class="footer_item" href="/archive">archive</a> <a class="footer_item" href="/tags">tags</a> <a class="footer_item" href="/feed.xml">rss</a> <span class="footer_item">&copy; 2024</span> </footer> <script src="/assets/js/main.js" defer="defer"></script> </div> </body> </html>
