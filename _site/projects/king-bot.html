<!DOCTYPE html> <html lang="en-US"> <head prefix="og: http://ogp.me/ns#"> <!-- TODO only add social media tags when keys are present! --> <meta charset="UTF-8" /> <meta http-equiv="X-UA-Compatible" content="ie=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <meta name="mobile-web-app-capable" content="yes" /> <meta name="apple-mobile-web-app-capable" content="yes" /> <meta name="application-name" content="Safwan Abdel Aal" /> <meta name="apple-mobile-web-app-status-bar-style" content="#fff" /> <meta name="apple-mobile-web-app-title" content="Safwan Abdel Aal" /> <title> KingBot - Automate Travian Kingdoms - Safwan Abdel Aal </title> <link rel="alternate" href="http://localhost:4000/projects/king-bot" hreflang="en-US" /> <link rel="canonical" href="http://localhost:4000/projects/king-bot" /> <meta name="description" content="learning by doing" /> <meta name="referrer" content="no-referrer-when-downgrade" /><meta property="og:site_name" content="KingBot - Automate Travian Kingdoms | Safwan Abdel Aal" /> <meta property="og:title" content="KingBot - Automate Travian Kingdoms | Safwan Abdel Aal" /> <meta property="og:type" content="website" /> <meta property="og:url" content="http://localhost:4000/projects/king-bot" /> <meta property="og:description" content="learning by doing" /> <meta property="og:image" content="" /> <meta property="og:image:width" content="640" /> <meta property="og:image:height" content="640" /> <meta name="twitter:card" content="summary" /> <meta name="twitter:title" content="KingBot - Automate Travian Kingdoms | " /> <meta name="twitter:url" content="http://localhost:4000/projects/king-bot" /> <meta name="twitter:site" content="@" /> <meta name="twitter:creator" content="@" /> <meta name="twitter:description" content="learning by doing" /> <meta name="twitter:image" content="" /> <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Safwan Abdel Aal" /> <!-- TODO make it available on mobile <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicons/apple-touch-icon.png" /> <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/favicon-32x32.png" /> <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicons/favicon-16x16.png" /> <link rel="manifest" href="/assets/favicons/site.webmanifest" /> <link rel="mask-icon" href="/assets/favicons/safari-pinned-tab.svg" color="#5bbad5" /> --> <meta name="msapplication-TileColor" content="#da532c" /> <meta name="theme-color" content="#2c2c2c" /> <link rel="stylesheet" href="/assets/css/style.css" /></head> <body data-theme="light" class="notransition"> <script> const body = document.body; const setUtterancesTheme = theme => { const utterances = document.querySelector('.utterances-frame'); if (!utterances) return; utterances.contentWindow.postMessage( {type: 'set-theme', theme: `github-${theme}`}, 'https://utteranc.es', ); }; const setMixcloudTheme = theme => { const oldTheme = theme == 'light' ? 'dark' : 'light'; const selection = document.getElementsByTagName('iframe'); const iframes = Array.prototype.slice.call(selection); iframes.forEach(iframe => { if (!iframe.src.match(/mixcloud/g)) { return; } iframe.setAttribute('src', iframe.src.replace(oldTheme, theme)); }); }; const initTheme = theme => { if (!theme) theme = body.getAttribute('data-theme'); localStorage.setItem('theme', theme); body.setAttribute('data-theme', theme); setUtterancesTheme(theme); setMixcloudTheme(theme); }; window.initTheme = initTheme; initTheme(localStorage.getItem("theme")); setTimeout(() => body.classList.remove("notransition"), 75); addEventListener('message', event => { if (event.origin !== 'https://utteranc.es') return; setUtterancesTheme(localStorage.getItem("theme")); }); </script> <div class="navbar" role="navigation"> <nav class="menu"> <input type="checkbox" id="menu-trigger" class="menu-trigger" /> <label for="menu-trigger"> <span class="menu-icon"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <path d="M64,384H448V341.33H64Zm0-106.67H448V234.67H64ZM64,128v42.67H448V128Z" /> </svg> </span> </label> <a id="mode"> <svg class="mode-sunny" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>LIGHT</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> <svg class="mode-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>DARK</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> </a> <div class="title"> <a class="menu-link active" href="http://localhost:4000">Safwan Abdel Aal</a> </div> <div class="trigger"> <div class="trigger-container"><a class="menu-link" href="/">blog</a><a class="menu-link" href="/about">about</a><a class="menu-link" href="/music">music</a><a class="menu-link" href="/ideas">ideas</a><a class="menu-link rss" href="/feed.xml"> <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 512 512" fill="#ED812E" > <title>RSS</title> <path d="M108.56,342.78a60.34,60.34,0,1,0,60.56,60.44A60.63,60.63,0,0,0,108.56,342.78Z" /> <path d="M48,186.67v86.55c52,0,101.94,15.39,138.67,52.11s52,86.56,52,138.67h86.66C325.33,312.44,199.67,186.67,48,186.67Z" /> <path d="M48,48v86.56c185.25,0,329.22,144.08,329.22,329.44H464C464,234.66,277.67,48,48,48Z" /> </svg> </a> </div> </div> </nav> </div> <div class="wrapper post"> <main class="page-content" aria-label="Content"> <article itemscope itemtype="https://schema.org/BlogPosting"> <header class="header"> <h1 class="header-title" itemprop="headline">KingBot - Automate Travian Kingdoms</h1> <div class="post-meta"> <time datetime="2018-06-19T00:15:00+03:00" itemprop="datePublished"> Jun 18, 2018 </time> <span itemprop="author" itemscope itemtype="https://schema.org/Person"> <span itemprop="name">Safwan Abdel Aal</span> </span> <time hidden datetime="" itemprop="dateModified"> Jun 18, 2018 </time> <span hidden itemprop="publisher" itemtype="Person">Safwan Abdel Aal</span> <span hidden itemprop="image"></span> <span hidden itemprop="mainEntityOfPage"></span> </div> </header> <div class="page-content" itemprop="articleBody"> <p>Welcome to my personal documentation site for <a href="https://github.com/scriptworld-git/king-bot">king-bot</a>.</p> <p>Since I already wrote a really good documentation on the original GitHub repository, it would be kinda dumb to copy and paste the readme.md onto this website.<br /> That’s why I decided to talk more about the ‘why’ on this project page.</p> <h2 id="general"> <a href="#general" class="anchor-head"></a> general </h2> <p>The project is written in <a href="https://www.python.org">Python 3</a> with the <a href="http://selenium-python.readthedocs.io">Selenium</a> package. Selenium is a tool for automating your tasks.<br /> It opens a new browser instance which can be controlled by code.<br /> My project <a href="/projects/series-monitor">Series-Monitor</a> was also writte with the help of selenium, but I wrote it in Java so there is way more overhead than a project written in python.<br /> That was acceptable because it also had a GUI, king-bot was originally planned without a gui. At least the core of it.</p> <p>Another good reason to write this project in python was the fact that I never ever written even one line in python and really wanted to learn this language, since it is really popular in the automated testing industry.</p> <h4 id="why-travian-kingdoms-"> <a href="#why-travian-kingdoms-" class="anchor-head"></a> why travian kingdoms ? </h4> <p>Good question.<br /> I played that game some years ago, the old and new version, and had alot of fun doing so.<br /> The community is really friendly and I had the pleasure to meet plenty of nice people.</p> <p>There is one bad factor about this game. You need to be online <strong>alot</strong> to be a successful player.<br /> Seems fair right ? No. You only have to click once every 10 min, send your farmlists and leave the game again…<br /> That was really boring and frustrating cause no one wants to get up in the middle of the game just for a little browsergame.</p> <p>In the past I solved this problem with a little ‘auto-clicker’ tool, running the whole night, pressing one single button.<br /> This was okay but I wanted more features like adding new farms and removing red farms from the farmlist.</p> <p>The idea of king-bot was born !</p> <p>Unfortunately I had no spare time programming the bot because of other projects. I wanted to learn web development instead.<br /> Now, some months later I finally started this project with it’s basic features in hope that many other people will join and help me improving this bot.</p> <h2 id="classes"> <a href="#classes" class="anchor-head"></a> classes </h2> <p>In general I choosed one class for every component in the game.<br /> That helped alot because once you initialized all villages for example, you just have to call one function <code class="language-plaintext highlighter-rouge">openVillage(2)</code> on the gameworld class and you opened it.<br /> There is no need for defining every possible state of the game in functions because a class always knows its state and can handle accordingly to it.</p> <p>This helps alot when programming new features because it’s really easy to associate them with one of those gameobjects.</p> <p>I got classes for:</p> <ul> <li>account</li> <li>gameworld</li> <li>village</li> <li>(resource/building) slot</li> </ul> <hr /> <p><strong>update:</strong> <em>25.07.18</em></p> <p>I decided to move all logic out of these classes.<br /> In nearly every function I had to use some functions from the parent class so I thought a little bit longer about the structure.<br /> The whole project is more like a functional process. Every ‘command’ has it’s own, independent structure.<br /> For example, the farming thread doesn’t care if slot xy is upgradeable or not.</p> <p>Because the plan for a GUI is in my head, I moved all gamestate out of the functional process.<br /> The above structure represents the whole gamestate now, and the classes only contain functions which load the game state.<br /> For now they are not implemented, but they will be really usefull when showing the state in a GUI.</p> <h2 id="custom-driver"> <a href="#custom-driver" class="anchor-head"></a> custom driver </h2> <p>Seleniums base driver class is really good in general, but I am a huge fan of short function names and deep class structures.<br /> That allows me to make easier changes on general tasks like finding and element.</p> <p>There is one example I wanna mention to explain myself a little bit better.<br /> If I want to wait after clicking on a button for the page to load, you can simply put a <code class="language-plaintext highlighter-rouge">time.sleep(2)</code> statement after your click.<br /> I decided to make a function on my custom browser class like the following:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">sleep</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">seconds</span><span class="p">):</span>
    <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span>
</code></pre></div></div> <p>At first many people might say:</p> <blockquote> <p>uhm that is really ridiculous !</p> </blockquote> <p>A few days later I implemented the headless mode and this function saved my life.</p> <p>After a while I thought:</p> <blockquote> <p>well, the browser is alot faster because it doesn’t have to load all the images… now I have to adjust all my sleep times to be shorter, or no one will ever notice the bot being faster in headless mode’.</p> </blockquote> <p>Having the function 2 lines of code later I was done adjusting the sleep times in headless mode.<br /> After setting a class attribute called <code class="language-plaintext highlighter-rouge">self.headless = True</code> I edited my function:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">sleep</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">seconds</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">headless</span><span class="p">:</span>
        <span class="n">seconds</span> <span class="o">=</span> <span class="n">seconds</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span>
</code></pre></div></div> <p>Done.</p> <p>Life can be really easy sometimes, just think a little into the future when planning your project.<br /> Make things like that your habit, and your are good to go.</p> <h3 id="use_browser-decorator"> <a href="#use_browser-decorator" class="anchor-head"></a> use_browser decorator </h3> <p>If any Thread wants to access the browser, it needs to call <code class="language-plaintext highlighter-rouge">browser.use()</code> and when finished <code class="language-plaintext highlighter-rouge">browser.done()</code> method.<br /> This prevents many Threads from clicking in the browser at the same time. It would be a complete mess !</p> <p>All code using the browser, was also always in an <code class="language-plaintext highlighter-rouge">try-catch</code> block, so it releases the browser even though an exception occured.<br /> In the future I want to reload the startpage after an exception occured, so there won’t be any window open, which may confuse the next Thread.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">use_browser</span><span class="p">(</span><span class="n">org_func</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">browser</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">type</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="ow">is</span> <span class="n">client</span><span class="p">:</span>
                <span class="n">browser</span> <span class="o">=</span> <span class="n">arg</span>
                <span class="k">break</span>

        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nf">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="n">client</span><span class="p">:</span>
                <span class="n">browser</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">browser</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nf">org_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">rv</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">browser</span><span class="p">.</span><span class="nf">use</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">rv</span> <span class="o">=</span> <span class="nf">org_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rv</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="nf">log</span><span class="p">(</span><span class="sh">"</span><span class="s">exception in function: {} exception: {}</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span>
                <span class="n">org_func</span><span class="p">.</span><span class="n">__name__</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">browser</span><span class="p">.</span><span class="nf">done</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">rv</span>

<span class="k">return</span> <span class="n">wrapper</span>
</code></pre></div></div> <p>This decorator can be used liked this:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@use_browser</span>
<span class="k">def</span> <span class="nf">start_farming</span><span class="p">(</span><span class="n">browser</span><span class="p">:</span><span class="n">client</span><span class="p">,</span> <span class="p">...):</span>
    <span class="k">pass</span>
</code></pre></div></div> <p>Writing this function is now kinda easy. No Try-Catch, no <code class="language-plaintext highlighter-rouge">browser.use()</code>.</p> <p>Also, if I want to implement refreshing the page after an error occured, there is only one place I need to insert the new code in. Damn handy.</p> </div> </article> </main> <footer class="footer"><a class="footer_item" href="https://github.com/sabdelaal" rel="noreferrer" target="_blank">github</a><a class="footer_item" href="https://www.linkedin.com/in/safwanabdelaal/" rel="noreferrer" target="_blank">linkedin</a><a class="footer_item" href="/archive">archive</a> <a class="footer_item" href="/tags">tags</a> <a class="footer_item" href="/feed.xml">rss</a> <span class="footer_item">&copy; 2024</span> </footer> <script src="/assets/js/main.js" defer="defer"></script> </div> </body> </html>
